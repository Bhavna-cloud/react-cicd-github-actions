name: Deploy React To GitHub Pages

on:
    push:
        branches:
            - main
            - 'feature/'
        paths-ignore:
            - '.github/workflows/*'
            - README.md    
    workflow_dispatch:        

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Get Code
              uses: actions/checkout@v4

            - name: Install Node 20
              uses: actions/setup-node@v4
              with:
                node-version: 20

            - name: Cache Dependencies
              uses: actions/cache@v4
              with:
                path: ~/.npm
                key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }} 

            - name: Install Dependencies
              run: npm ci 

            - name: Run Tests
              run: npm run test

            - name: Send Slack Notification (Test)
              if: always()
              env:
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
              run: |
                if [ -z "$SLACK_WEBHOOK" ]; then
                  echo "SLACK_WEBHOOK is not set. Skipping notification."
                  exit 0
                fi
                
                STATUS=${{ job.status }}
                BRANCH=${{ github.ref_name }}
                COMMIT=${{ github.sha }}
                REPO=${{ github.repository }}
                JOB="Test"

                if [ "$STATUS" == "success" ]; then
                  COLOR="#36a64f"
                  EMOJI="✅"
                elif [ "$STATUS" == "failure" ]; then
                  COLOR="#ff0000"
                  EMOJI="❌"
                else
                  COLOR="#ffcc00"
                  EMOJI="⚠"
                fi

                curl -X POST -H 'Content-type: application/json' --data '{
                  "text": "GitHub Actions Notification",
                  "attachments": [
                    {
                      "color": "'"$COLOR"'",
                      "blocks": [
                        {
                          "type": "section",
                          "text": {
                            "type": "mrkdwn",
                            "text": "Workflow: Deploy React To GitHub Pages\n*Job:* '"$JOB"'\n*Branch:* '"$BRANCH"'\n*Commit:* '"$COMMIT"'\n*Status:* '"$EMOJI"' '"$STATUS"'"
                          }
                        },
                        {
                          "type": "context",
                          "elements": [
                            {
                              "type": "mrkdwn",
                              "text": "Repository: <https://github.com/'"$REPO"'|'"$REPO"'>"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }' $SLACK_WEBHOOK

    build:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: Get Code
              uses: actions/checkout@v4 

            - name: Install Node 20
              uses: actions/setup-node@v4
              with:
                node-version: 20

            - name: Cache Dependencies
              uses: actions/cache@v4
              with:
                path: ~/.npm
                key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}     

            - name: Install Dependencies
              run: npm ci

            - name: Build Project
              run: npm run build

            - name: Upload Dist Artifact
              uses: actions/upload-pages-artifact@v3
              with:
                name: github-pages
                path: dist

            - name: Send Slack Notification (Build)
              if: always()
              env:
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
              run: |
                if [ -z "$SLACK_WEBHOOK" ]; then
                  echo "SLACK_WEBHOOK is not set. Skipping notification."
                  exit 0
                fi

                STATUS=${{ job.status }}
                BRANCH=${{ github.ref_name }}
                COMMIT=${{ github.sha }}
                REPO=${{ github.repository }}
                JOB="Build"

                if [ "$STATUS" == "success" ]; then
                  COLOR="#36a64f"
                  EMOJI="✅"
                elif [ "$STATUS" == "failure" ]; then
                  COLOR="#ff0000"
                  EMOJI="❌"
                else
                  COLOR="#ffcc00"
                  EMOJI="⚠"
                fi

                curl -X POST -H 'Content-type: application/json' --data '{
                  "text": "GitHub Actions Notification",
                  "attachments": [
                    {
                      "color": "'"$COLOR"'",
                      "blocks": [
                        {
                          "type": "section",
                          "text": {
                            "type": "mrkdwn",
                            "text": "Workflow: Deploy React To GitHub Pages\n*Job:* '"$JOB"'\n*Branch:* '"$BRANCH"'\n*Commit:* '"$COMMIT"'\n*Status:* '"$EMOJI"' '"$STATUS"'"
                          }
                        },
                        {
                          "type": "context",
                          "elements": [
                            {
                              "type": "mrkdwn",
                              "text": "Repository: <https://github.com/'"$REPO"'|'"$REPO"'>"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }' $SLACK_WEBHOOK

    deploy:
        needs: build
        runs-on: ubuntu-latest
        permissions:
           pages: write      
           id-token: write    
        environment:
           name: github-pages
           url: ${{ steps.deployment.outputs.page_url }}
        steps:
           - name: Deploy to GitHub Pages
             id: deployment
             uses: actions/deploy-pages@v4  
             with:
                token: ${{ secrets.GITHUB_TOKEN }}

           - name: Debug Slack Webhook (Deploy)
             run: echo "SLACK_WEBHOOK=${{ secrets.SLACK_WEBHOOK_URL }}"

           - name: Send Slack Notification (Deploy)
             if: always()
             env:
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
             run: |
               if [ -z "$SLACK_WEBHOOK" ]; then
                 echo "SLACK_WEBHOOK is not set. Skipping notification."
                 exit 0
               fi

               STATUS=${{ job.status }}
               BRANCH=${{ github.ref_name }}
               COMMIT=${{ github.sha }}
               REPO=${{ github.repository }}
               JOB="Deploy"

               if [ "$STATUS" == "success" ]; then
                 COLOR="#36a64f"
                 EMOJI="✅"
               elif [ "$STATUS" == "failure" ]; then
                 COLOR="#ff0000"
                 EMOJI="❌"
               else
                 COLOR="#ffcc00"
                 EMOJI="⚠"
               fi

               curl -X POST -H 'Content-type: application/json' --data '{
                 "text": "GitHub Actions Notification",
                 "attachments": [
                   {
                     "color": "'"$COLOR"'",
                     "blocks": [
                       {
                         "type": "section",
                         "text": {
                           "type": "mrkdwn",
                           "text": "Workflow: Deploy React To GitHub Pages\n*Job:* '"$JOB"'\n*Branch:* '"$BRANCH"'\n*Commit:* '"$COMMIT"'\n*Status:* '"$EMOJI"' '"$STATUS"'"
                         }
                       },
                       {
                         "type": "context",
                         "elements": [
                           {
                             "type": "mrkdwn",
                             "text": "Repository: <https://github.com/'"$REPO"'|'"$REPO"'>"
                           }
                         ]
                       }
                     ]
                   }
                 ]
               }' $SLACK_WEBHOOK
